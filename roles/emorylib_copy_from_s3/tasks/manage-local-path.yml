---
- name: Check if path already exists
  stat:
    path: '{{ local.path }}'
    follow: '{{ local.follow_symblink | d (true) }}'
  register: path_info

- name: Fail play if path exists and stop selected
  assert:
    that: not exists or (if == "delete" or if == "backup")
    fail_msg: Path already exists, must select delete or backup to continue play    

- name: Rename existing path if backup or delete
  shell: 'mv {{ local.path }} {{ local.path }}-{{ ansible_date_time.epoch }}'
  when: 
    - if == "delete" or if == "backup"
    - exists

- name: Delete folder async if delete
  file:
    path: '{{ local.path }}-{{ ansible_date_time.epoch }}'
    state: absent
  async: 10000
  poll: 0
  register: delete_job_info
  when:
    - if == "delete"
    - exists

- debug:
    var: delete_job_info

- name: Confirm delete job
  async_status:
    jid: '{{ delete_job_info.ansible_job_id }}'
  register: async_delete_job_info
  until: async_delete_job_info.finished
  retries: 100
  delay: 10


    
    