---
- name: Download from the bucket via aws s3 sync
  shell: >
    aws s3 sync s3://{{ s3.bucket }}/{{ s3.key_prefix | regex_replace(get_trailing_slash, "") }}{{ date_key is defined | ternary (__date_key, "") }}
    {{ local_path }}
  vars:
    get_trailing_slash: \/$
    __date_key: '/{{ date_key }}'

- name: Confirm delete job
  async_status:
    jid: '{{ delete_job_info.ansible_job_id }}'
  register: async_delete_job_info
  until: async_delete_job_info.finished
  retries: '{{ confirm_delete_retries }}'
  delay: '{{ confirm_delete_delay }}'
  when: 
    - copy_from_s3.local.if_path_exists | d () == "delete"
    - path_info.stat.exists