---
- name: Set IDP metadata
  set_fact:
    idp_metadata: "{{ idp_metadata|default({}) | combine( {'name': item.name}, {'url': item.url}, {'entity_id': item.entity_id} ) }}" 
  loop: "{{ metadata_endpoints | selectattr('name', 'eq', metadata_name ) | list }}"

- name: Download {{ idp_metadata.name }} IDP metadata
  get_url:
    url: "{{ idp_metadata.url }}"
    dest: "{{ sp_home }}/{{ idp_metadata.name }}-idp-metadata.xml"
    mode: 0755
    force: no

- name: Put in place shibboleth2.xml template
  template:
    src: shibboleth2_xml.j2
    dest: "{{ sp_home }}/shibboleth2.xml"

- name: Put in place Attribute Map
  get_url:
     url: "{{ idp_attribute_map_src }}"
     dest: "{{ sp_home }}/attribute-map.yml"
     mode: 0755

- name: Ensure archive folder exists
  file:
    path: "{{ item.dest }}"
    state: directory
  loop: "{{ archive_urls }}"
  when: item.create_dir 

- name: Download archive files
  unarchive:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    extra_opts: "{{ item.extra_opts }}"
    remote_src: yes
  ignore_errors: yes                    #-j breaks the module for unzip
  loop: "{{ archive_urls }}"

- name: Set permissions on directory
  file:
    path: "{{ sp_home }}"
    owner: shibd
    group: shibd
    recurse: yes
