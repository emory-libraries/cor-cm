---
# tasks file for wm_role_ec2_instance

- include_tasks:
    file: check-if-ec2-exists.yml
    apply:
      tags: create-ec2
  tags: create-ec2

- include_tasks:
    file: set-user-data.yml
    apply:
      tags:
        - create-ec2
  tags:
    - create-ec2
  when: not state.name | d (True)

- include_tasks:
    file: create-or-terminate-ec2.yml
    apply:
      tags:
        - create-ec2
  tags:
    - create-ec2
#  when: not ec2_private_ip | d (True)

- include_tasks: 
    file: wait-for-ec2.yml
    apply:
      tags:
        - create-ec2
  tags:
    - create-ec2
  when: ec2_state_name == "pending"

- name: Delete ec2 instance
  include_tasks:
    file: create-or-terminate-ec2.yml
  vars:
    ec2_state: absent
  tags:
    - delete-ec2
    - never

- include_tasks:
    file: terminate-ec2-instances-found.yml
    apply:
      tags:
        - delete-ec2
        - never
  tags:
    - delete-ec2
    - never
  when: ec2.changed

- include_tasks:
    file: terminate-ec2-none-found.yml
    apply:
      tags:
        - delete-ec2
        - never
  tags:
    - delete-ec2
    - never
  when: not ec2.changed
